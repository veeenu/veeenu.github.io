<!doctype html><html><head><meta charset=utf-8><meta content="width=device-width" name=viewport><meta content="Implementing Keyframe Animation" property=og:title><meta content=website property=og:type><meta content="Andrea Venuta" property=og:site_name><meta content="In this post I will show you the way I implemented a keyframe-based 3D real
time animation using WebGL. Familiarity with the WebGL &amp#x2F; OpenGL rendering
pipeline, and with linear algebra is necessary. There don&amp#x27;t seem to be
many well-made explainations online about real time 3D animation with
WebGL which aren&amp#x27;t involving Three.js and COLLADA so I hope that this will
be useful for those who wish to program their own animations." property=og:description><title>Implementing Keyframe Animation</title><link href=https://veeenu.github.io/style.css rel=stylesheet><link href=https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css rel=stylesheet><link integrity="sha512-vJqxkZ+Sugf/6WRlpcxN01qVfX/29hF6qc33eHF1va3NgoV+U+wCi+uTAsQ10sDoGyBxHLdaHvGwDlV3yVYboA==" crossorigin href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.1/katex.min.css referrerpolicy=no-referrer rel=stylesheet><script integrity="sha512-5ufNcHqOYgilGEHPfuRIQ5B/vDS1M8+UC+DESZ5CwVgGTg+b2Ol/15rYL/GiCWJ/Sx8oVo0FPFok1dPk8U9INQ==" crossorigin defer referrerpolicy=no-referrer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.1/katex.min.js></script><script integrity="sha512-MBhOGY4yRA2eATtRGTcrDJCRqcnLai5+uu47GA2ueVr1MPzirC/iogLWRA8CXTlOTK09VI4fdTe4qE4LBfjsHw==" crossorigin defer referrerpolicy=no-referrer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.1/contrib/mathtex-script-type.min.js></script><script integrity="sha512-ZA/RPrAo88DlwRnnoNVqKINnQNcWERzRK03PDaA4GIJiVZvGFIWQbdWCsUebMZfkWohnfngsDjXzU6PokO4jGw==" crossorigin defer referrerpolicy=no-referrer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.1/contrib/auto-render.min.js></script><script>document.addEventListener(`DOMContentLoaded`,(()=>{let a=`\$\$`,b=`\$`;renderMathInElement(document.body,{delimiters:[{left:a,right:a,display:!0},{left:b,right:b,display:!1},{left:`\\\\(`,right:`\\\\)`,display:!1},{left:`\\\\[`,right:`\\\\]`,display:!0}],throwOnError:!1})}))</script><body><header id=menu-header><a class=image href=https://veeenu.github.io> <div><img alt="Andrea Venuta" src=https://veeenu.github.io/me.jpg></div> <span>Andrea Venuta</span> </a><ul><li><a href=https://veeenu.github.io>About</a><li><a href=https://veeenu.github.io/blog.html>Blog</a></ul></header><div class="container top-container"><article class="article twelve columns"><header><h1>Implementing Keyframe Animation</h1><small> <p><time>Tuesday, 22 Apr 2014</time> Â· <em> Reading time: 15 mins </em></p> </small></header><section><p>In this post I will show you the way I implemented a keyframe-based 3D real time animation using WebGL. Familiarity with the WebGL / OpenGL rendering pipeline, and with linear algebra is necessary. There don't seem to be many well-made explainations online about real time 3D animation with WebGL which aren't involving Three.js and COLLADA so I hope that this will be useful for those who wish to program their own animations.</p><span id=continue-reading></span><p>We will model a mesh in Blender (a bit of familiarity is necessary here, too), rig it up, write a barebone set of shaders and boilerplate code from scratch, and then load, parse and run the animation in our WebGL context.<p>You can download all the materials for this tutorial <a href=/data/2014-04-22-implementing-keyframe-animation/veeenu-implementing-keyframe-animation.tgz>here</a>, or view them on GitHub <a href=https://github.com/veeenu/veeenu.github.io/tree/master/data/2014-04-22-implementing-keyframe-animation/veeenu-implementing-keyframe-animation>here</a>.<p>Keyframe based animation is one of the most known algorithms for animating 3D models, another very important one being skeletal animation / mesh skinning / rigging (or countless other names I've read it described as). Like all algorithms, it has upsides and downsides. Keyframe based animation consists of "taking snapshots" of the animated model at different points in time, which could be as many or as few as needed, and to render those frames one after the other. Optionally, you could linearly interpolate (<em>lerp</em>) the geometry between keyframes in order to have a smoother transition.<p>Skeletal animation expands the concept by implementing keyframe animation on a quite smaller mesh, which is called a <em>rig</em> or an <em>armature</em>. The vertices of the rig, and their transformation matrix, control each one a subset of the vertices of the main, bigger mesh, partially or totally, depending on a weight that each vertex of the main mesh has defined for each vertex of the rig. More concepts are involved, such as <a href=http://en.wikipedia.org/wiki/Inverse_kinematics>Inverse Kinematics</a> and bone parenting, but we will discuss those in another post dedicated specifically to skeletal animation.<p>Let's now look at when and why to use keyframe based animation.<h4 id=the-good>The good</h4><p>Keyframe based animation is useful when you can't (or don't want to) put too much pressure on the computation power of your GPU. Keyframes are created as Vertex Buffer Objects and the only operation required to switch between frames is to set the proper VBOs before a <code>drawElements</code> call, allowing you to write light-weight shader code.<h4 id=the-bad>The bad</h4><p>Keyframe based animation takes a LOT of VBO space. A simple, bare bone mesh like the one in this tutorial takes ~400kb for a handful of frames. Most of the time this isn't the case and your animation may get to various megabytes in a horribly fast manner, since we are cloning each vertex and each normal countless times. Also this isn't really physics-engine friendly because the code knows really nothing about the mesh, so it must use every vertex to do the calculations. Not cool. Skeletal animation is way more suited for situations like this one.<h4 id=the-ugly>The ugly</h4><p>Caution is advised, be mindful of where and why you are implementing this algorithm. In this tutorial we're going to use the Wavefront OBJ format for its simplicity but you'll want to find another format to hold your data, be it a roll-your-own JSON structure, COLLADA, FBX or whatever it is you are most comfortable working with. We're gonna cover WebGL but this really can be done in any language that supports an OpenGL-like rendering pipeline.<p>Okay, let's get to it!<h2 id=part-1-modeling-and-rigging>Part 1: Modeling and rigging</h2><p>We will use <a href=http://www.blender.org/>Blender</a> for this purpose. At the time of writing, version 2.70a is out. We will create a complete, usable (albeit very minimal) model of a barb-like thingamabob that bends itself towards the ground. The screenshots are <a href=/data/2014-04-22-implementing-keyframe-animation/veeenu-implementing-keyframe-animation.tgz>downloadable</a> in a higher resolution along with the rest of the code and the <em>.blend</em> file.<p><img alt="Step 01" src=/data/2014-04-22-implementing-keyframe-animation/steps/01.png><p>First of all, we will want to create a geometry like the one portrayed in <a href=/data/2014-04-22-implementing-keyframe-animation/steps/01.png>Step 01</a>. The way I did this was by extruding three times the upper face of a unit cube so that I had three connected cubes, one on top of each other, then I loop-selected (Alt + right click) the edges of the horizontal faces and scaled them to smaller values from bottom to top. Specifically I kept the lowermost face intact, scaled the next one to 0.75, the next one to 0.5 and the topmost to 0.0 - getting four vertices collapsed in the same spot, making a pyramid.<p>Next thing you want to do is to create an armature (see <a href=/data/2014-04-22-implementing-keyframe-animation/steps/02.png>Step 02</a>). Make sure your 3D cursor is at the bottom-center of the mesh, select <strong>Add > Armature > Single bone</strong>. Position the bone as shown in <a href=/data/2014-04-22-implementing-keyframe-animation/steps/03.png>Step 03</a> and then, keeping the upper joint (the little sphere) selected, extrude it twice and position the bones as seen in <a href=/data/2014-04-22-implementing-keyframe-animation/steps/04.png>Step 04</a>. Also, make sure the "Names" and "X-Ray" checkboxes are checked in the Display properties of the armature (see the panel on the right side) to help yourself with positioning. Rename then each of the three bones; you should now have something similar to <a href=/data/2014-04-22-implementing-keyframe-animation/steps/05.png>Step 05</a><p><img alt="Step 05" src=/data/2014-04-22-implementing-keyframe-animation/steps/05.png><p>Let's then add an <strong>Inverse Kinematic constraint</strong> to our rig. Right click the armature, enter <em>Pose Mode</em>, select the topmost bone and add a constraint as shown in <a href=/data/2014-04-22-implementing-keyframe-animation/steps/06.png>Step 06</a>.<p><a href=/data/2014-04-22-implementing-keyframe-animation/steps/07.png>Step 07</a> shows the constrained armature bending. We then proceed to parent the mesh to the armature by first selecting the mesh, then shift-selecting the armature (Shift + right click), then pressing <strong>Ctrl+P</strong> to bring out the parenting menu, and then selecting <strong>Armature deform - with automatic weights</strong> (<a href=/data/2014-04-22-implementing-keyframe-animation/steps/08.png>Step 08</a>).<p>We must now set the chain length of the inverse kinematic constraint to 2; this will limit its influence to the top and middle bones, so the bottom one can stay put while the other two bend towards the ground, to obtain the effect seen in <a href=/data/2014-04-22-implementing-keyframe-animation/steps/09.png>Step 09</a>.<p>Now is the time to animate our armature. Let's keyframe the neutral position at frame 0 by selecting the whole armature in <em>Pose Mode</em>, pressing <strong>I</strong> in the 3D view and choosing <strong>LocRotScale</strong> (<a href=/data/2014-04-22-implementing-keyframe-animation/steps/10.png>Step 10</a>). Let's then bend a little bit the topmost bone and repeat the keyframing, twice, at frames 10 and 20 (<a href=/data/2014-04-22-implementing-keyframe-animation/steps/11.png>Steps 11</a>, <a href=/data/2014-04-22-implementing-keyframe-animation/steps/12.png>12</a>). To make the animation symmetric, copy and paste the pose at frame 10 on frame 30, and the pose at frame 0 on frame 40, as shown in <a href=/data/2014-04-22-implementing-keyframe-animation/steps/13.png>Steps 13</a> <a href=/data/2014-04-22-implementing-keyframe-animation/steps/14.png>and 14</a>. Set the start frame to 0 and the end frame to 40 as shown in <a href=/data/2014-04-22-implementing-keyframe-animation/steps/15.png>Step 15</a>.<p><strong>IMPORTANT STEP, DO NOT SKIP</strong>. Add a <em>Triangulate faces</em> modifier to the mesh, move it on top of the armature modifier and apply it immediately. This will allow us to export coherent animation frames, because Blender's OBJ exporter's "triangulate" option causes a bit of trouble (<a href=/data/2014-04-22-implementing-keyframe-animation/steps/16.png>Step 16</a>).<p><img alt="Step 16" src=/data/2014-04-22-implementing-keyframe-animation/steps/16.png><p>You will also want to UV Unwrap the mesh, so that the texture mapping is included in the exported file. This is important if you are going to use the parser included in the download code, since it doesn't handle missing texture coordinates. At last, export as OBJ file; it is important that the options are coherent with what is shown in <a href=/data/2014-04-22-implementing-keyframe-animation/steps/17.png>Step 17</a>, for the same reason (poorly written parser).<p>Yay, we made it!<h2 id=part-2-animating-the-model-in-webgl>Part 2: Animating the model in WebGL</h2><h3 id=2-1-boilerplate>2.1 Boilerplate</h3><p>First of all, let's get the boilerplate code out of the way. We will use no external libraries besides <a href=http://glmatrix.net>gl-matrix</a>. We will use a barebone flat shader program, reported below:<pre class=language-glsl data-lang=glsl style=color:#6c7079;background-color:#2b303b><code class=language-glsl data-lang=glsl><span style=color:#5f697a;font-style:italic>// Vertex shader - vertex.glsl
</span><span style=color:#cd74e8>uniform mat4</span><span style=color:#abb2bf> uP, uV, uM;
</span><span style=color:#cd74e8>uniform mat3</span><span style=color:#abb2bf> uN;
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>attribute vec3</span><span style=color:#abb2bf> aVertex, aNormal;
</span><span style=color:#cd74e8>attribute vec2</span><span style=color:#abb2bf> aTexCoord;
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>varying vec3</span><span style=color:#abb2bf> vVertex, vNormal;
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>void </span><span style=color:#5cb3fa>main</span><span style=color:#abb2bf>() {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl_Position </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> uP </span><span style=color:#adb7c9>*</span><span style=color:#abb2bf> uV </span><span style=color:#adb7c9>*</span><span style=color:#abb2bf> uM </span><span style=color:#adb7c9>* </span><span style=color:#cd74e8>vec4</span><span style=color:#abb2bf>(aVertex, </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  vVertex </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> aVertex;
</span><span style=color:#abb2bf>  vNormal </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> aNormal;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>}
</span></code></pre><pre class=language-glsl data-lang=glsl style=color:#6c7079;background-color:#2b303b><code class=language-glsl data-lang=glsl><span style=color:#5f697a;font-style:italic>// Fragment shader - fragment.glsl
</span><span style=color:#abb2bf>precision highp </span><span style=color:#cd74e8>float</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>uniform mat4</span><span style=color:#abb2bf> uP, uV, uM;
</span><span style=color:#cd74e8>uniform mat3</span><span style=color:#abb2bf> uN;
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>uniform sampler2D</span><span style=color:#abb2bf> uSampler;
</span><span style=color:#cd74e8>varying vec3</span><span style=color:#abb2bf> vVertex, vNormal;
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>void </span><span style=color:#5cb3fa>main</span><span style=color:#abb2bf>() {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf> lAmbient </span><span style=color:#adb7c9>= </span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf>(</span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf> lDiffuse </span><span style=color:#adb7c9>= </span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf>(</span><span style=color:#db9d63>0.5</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0.5</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf> lSpecular</span><span style=color:#adb7c9>= </span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf>(</span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf> plPos </span><span style=color:#adb7c9>= </span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf>(</span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>3.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>5.0</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf> plDir </span><span style=color:#adb7c9>= </span><span style=color:#5ebfcc>normalize</span><span style=color:#abb2bf>(plPos </span><span style=color:#adb7c9>-</span><span style=color:#abb2bf> vVertex);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>mat4</span><span style=color:#abb2bf> mvp </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> uP </span><span style=color:#adb7c9>*</span><span style=color:#abb2bf> uV </span><span style=color:#adb7c9>*</span><span style=color:#abb2bf> uM;
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf> n </span><span style=color:#adb7c9>= </span><span style=color:#5ebfcc>normalize</span><span style=color:#abb2bf>(uN </span><span style=color:#adb7c9>*</span><span style=color:#abb2bf> vNormal);
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf> l </span><span style=color:#adb7c9>= </span><span style=color:#5ebfcc>normalize</span><span style=color:#abb2bf>(</span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf>(mvp </span><span style=color:#adb7c9>* </span><span style=color:#cd74e8>vec4</span><span style=color:#abb2bf>(plDir, </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>)));
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf> v </span><span style=color:#adb7c9>= </span><span style=color:#5ebfcc>normalize</span><span style=color:#abb2bf>(</span><span style=color:#adb7c9>-</span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf>(mvp </span><span style=color:#adb7c9>* </span><span style=color:#cd74e8>vec4</span><span style=color:#abb2bf>(vVertex, </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>)));
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>vec3</span><span style=color:#abb2bf> r </span><span style=color:#adb7c9>= </span><span style=color:#5ebfcc>reflect</span><span style=color:#abb2bf>(l, n);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>float</span><span style=color:#abb2bf> lambert </span><span style=color:#adb7c9>= </span><span style=color:#5ebfcc>dot</span><span style=color:#abb2bf>(l, n),
</span><span style=color:#abb2bf>        ambientInt </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>0.2</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>        specularInt </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>0.5</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>        diffuseInt </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>        shininess </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>128.0</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>float</span><span style=color:#abb2bf> specular </span><span style=color:#adb7c9>= </span><span style=color:#5ebfcc>pow</span><span style=color:#abb2bf>( </span><span style=color:#5ebfcc>max</span><span style=color:#abb2bf>( </span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>, </span><span style=color:#5ebfcc>dot</span><span style=color:#abb2bf>(r,v) ), shininess );
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl_FragColor </span><span style=color:#adb7c9>= </span><span style=color:#cd74e8>vec4</span><span style=color:#abb2bf>(
</span><span style=color:#abb2bf>      lAmbient </span><span style=color:#adb7c9>*</span><span style=color:#abb2bf> ambientInt </span><span style=color:#adb7c9>+
</span><span style=color:#abb2bf>      lDiffuse </span><span style=color:#adb7c9>*</span><span style=color:#abb2bf> diffuseInt </span><span style=color:#adb7c9>*</span><span style=color:#abb2bf> lambert </span><span style=color:#adb7c9>+
</span><span style=color:#abb2bf>      lSpecular </span><span style=color:#adb7c9>*</span><span style=color:#abb2bf> specularInt </span><span style=color:#adb7c9>*</span><span style=color:#abb2bf> specular
</span><span style=color:#abb2bf>      , </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>}
</span></code></pre><p>We will then want to initialize our WebGL context, load and compile our shader program and make the uniforms' and attributes' locations available to the "outside". For simplicity, we are loading the shaders via a synchronous XMLHttpRequest so we don't get caught up in callbacks and promises. Clearly, those are things that should be addressed in production code because it is unacceptable to make the user wait with the browser idle while the assets are loaded, but this is not the main focus of the post.<pre class=language-js data-lang=js style=color:#6c7079;background-color:#2b303b><code class=language-js data-lang=js><span style=color:#5f697a;font-style:italic>// Initialize WebGL context
</span><span style=color:#cd74e8>var </span><span style=color:#eb6772>gl </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>(</span><span style=color:#cd74e8>function</span><span style=color:#abb2bf>() {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>canvas </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>document.</span><span style=color:#5ebfcc>getElementById</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>'canvas'</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>canvas</span><span style=color:#abb2bf>.style.</span><span style=color:#eb6772>position </span><span style=color:#adb7c9>= </span><span style=color:#9acc76>'fixed'</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>gl </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>canvas</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>getContext</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>'webgl'</span><span style=color:#abb2bf>) </span><span style=color:#adb7c9>||
</span><span style=color:#abb2bf>           </span><span style=color:#eb6772>canvas</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>getContext</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>'experimental-webgl'</span><span style=color:#abb2bf>) </span><span style=color:#adb7c9>||
</span><span style=color:#abb2bf>           </span><span style=color:#f0c678>console</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>log</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>'WebGL unsupported'</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>canvas</span><span style=color:#abb2bf>.width </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>window.innerWidth;
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>canvas</span><span style=color:#abb2bf>.height </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>window.innerHeight;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>viewport</span><span style=color:#abb2bf>(</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>canvas</span><span style=color:#abb2bf>.width, </span><span style=color:#eb6772>canvas</span><span style=color:#abb2bf>.height);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  window.</span><span style=color:#5ebfcc>addEventListener</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>'resize'</span><span style=color:#abb2bf>, </span><span style=color:#cd74e8>function</span><span style=color:#abb2bf>() {
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>canvas</span><span style=color:#abb2bf>.width </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>window.innerWidth;
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>canvas</span><span style=color:#abb2bf>.height </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>window.innerHeight;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>viewport</span><span style=color:#abb2bf>(</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>canvas</span><span style=color:#abb2bf>.width, </span><span style=color:#eb6772>canvas</span><span style=color:#abb2bf>.height);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  });
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>return </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>}());
</span><span style=color:#abb2bf>
</span><span style=color:#5f697a;font-style:italic>// Compile the shader program, pack the uniform locations in it and
</span><span style=color:#5f697a;font-style:italic>// return the whole thing
</span><span style=color:#cd74e8>var </span><span style=color:#eb6772>prog </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>(</span><span style=color:#cd74e8>function</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>attribs</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>uniforms</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>var </span><span style=color:#5cb3fa>compileShader </span><span style=color:#adb7c9>= </span><span style=color:#cd74e8>function</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>source</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>type</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>xhr </span><span style=color:#adb7c9>= new </span><span style=color:#abb2bf>XMLHttpRequest();
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>xhr</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>open</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>'GET'</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>source</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>false</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>xhr</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>send</span><span style=color:#abb2bf>();
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>shader </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>createShader</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>type</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>shaderSource</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>shader</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>xhr</span><span style=color:#abb2bf>.responseText);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>compileShader</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>shader</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>    </span><span style=color:#f0c678>console</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>log</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>'Shader compilation:'</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>getShaderInfoLog</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>shader</span><span style=color:#abb2bf>));
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>return </span><span style=color:#eb6772>shader</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>  }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>program </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>createProgram</span><span style=color:#abb2bf>();
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>attachShader</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>program</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>                  </span><span style=color:#5cb3fa>compileShader</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>'vertex.glsl'</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>VERTEX_SHADER</span><span style=color:#abb2bf>));
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>attachShader</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>program</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>                  </span><span style=color:#5cb3fa>compileShader</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>'fragment.glsl'</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>FRAGMENT_SHADER</span><span style=color:#abb2bf>));
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>linkProgram</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>program</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>useProgram</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>program</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>for</span><span style=color:#abb2bf>(</span><span style=color:#cd74e8>var </span><span style=color:#eb6772>i </span><span style=color:#adb7c9>in </span><span style=color:#eb6772>attribs</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>program</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>attribs</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>i</span><span style=color:#abb2bf>]] </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>getAttribLocation</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>program</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>attribs</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>i</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>for</span><span style=color:#abb2bf>(</span><span style=color:#cd74e8>var </span><span style=color:#eb6772>i </span><span style=color:#adb7c9>in </span><span style=color:#eb6772>uniforms</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>program</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>uniforms</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>i</span><span style=color:#abb2bf>]] </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>getUniformLocation</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>program</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>uniforms</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>i</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>return </span><span style=color:#eb6772>program</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>}(
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>  [</span><span style=color:#9acc76>'aVertex'</span><span style=color:#abb2bf>, </span><span style=color:#9acc76>'aNormal'</span><span style=color:#abb2bf>],
</span><span style=color:#abb2bf>  [</span><span style=color:#9acc76>'uM'</span><span style=color:#abb2bf>, </span><span style=color:#9acc76>'uV'</span><span style=color:#abb2bf>, </span><span style=color:#9acc76>'uP'</span><span style=color:#abb2bf>, </span><span style=color:#9acc76>'uN'</span><span style=color:#abb2bf>]
</span><span style=color:#abb2bf>));
</span></code></pre><p>Let's abstract the logic behind the construction and drawing process of a mesh. We create a <code>Mesh</code> object whose constructor takes a geometry layout (vertices, indices, normals and other information) and creates buffers in GPU memory space that will contain the data. It is mostly a matter of <code>createBuffer</code>, <code>bindBuffer</code> and <code>bufferData</code> calls.<pre class=language-js data-lang=js style=color:#6c7079;background-color:#2b303b><code class=language-js data-lang=js><span style=color:#cd74e8>var </span><span style=color:#5cb3fa>Mesh </span><span style=color:#adb7c9>= </span><span style=color:#cd74e8>function</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>geometry </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>vertexBuffer  </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>createBuffer</span><span style=color:#abb2bf>();
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>indexBuffer   </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>createBuffer</span><span style=color:#abb2bf>();
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>normalBuffer  </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>createBuffer</span><span style=color:#abb2bf>();
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>bindBuffer</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ARRAY_BUFFER</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>vertexBuffer</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>bufferData</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ARRAY_BUFFER</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>                </span><span style=color:#adb7c9>new </span><span style=color:#abb2bf>Float32Array(</span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>vertices</span><span style=color:#abb2bf>),
</span><span style=color:#abb2bf>                </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>STATIC_DRAW
</span><span style=color:#abb2bf>               );
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>bindBuffer</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ARRAY_BUFFER</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>normalBuffer</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>bufferData</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ARRAY_BUFFER</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>                </span><span style=color:#adb7c9>new </span><span style=color:#abb2bf>Float32Array(</span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>normals</span><span style=color:#abb2bf>),
</span><span style=color:#abb2bf>                </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>STATIC_DRAW
</span><span style=color:#abb2bf>               );
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>bindBuffer</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ELEMENT_ARRAY_BUFFER</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>indexBuffer</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>bufferData</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ELEMENT_ARRAY_BUFFER</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>                </span><span style=color:#adb7c9>new </span><span style=color:#abb2bf>Uint16Array(</span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>indices</span><span style=color:#abb2bf>),
</span><span style=color:#abb2bf>                </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>STATIC_DRAW
</span><span style=color:#abb2bf>               );
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>bindBuffer</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ARRAY_BUFFER</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>null</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>bindBuffer</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ELEMENT_ARRAY_BUFFER</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>null</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>}
</span></code></pre><p>The <code>geometry</code> object will also hold spatial information that will allow us to construct the model matrix (<code>uM</code> in the shaders). This information is <code>position</code>, <code>rotation</code> and <code>scale</code> and we will use the excellent <code>gl-matrix</code> library to calculate the matrix at each draw call. We will also calculate the normal matrix (<code>uN</code>), needed for the lighting algorithm, as the inverse transpose of the model matrix. Then we will bind the matrices to the corresponding uniforms, bind the buffers to the attributes, issue a call to <code>drawElements</code> and unbind the buffers until the next call.<pre class=language-js data-lang=js style=color:#6c7079;background-color:#2b303b><code class=language-js data-lang=js><span style=color:#f0c678>Mesh</span><span style=color:#abb2bf>.prototype.</span><span style=color:#5cb3fa>draw </span><span style=color:#adb7c9>= </span><span style=color:#cd74e8>function</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>baseMatrix</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>mvMatrix </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>mat4</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>create</span><span style=color:#abb2bf>();
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>nMatrix  </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>mat3</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>create</span><span style=color:#abb2bf>();
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>if</span><span style=color:#abb2bf>(</span><span style=color:#adb7c9>typeof </span><span style=color:#eb6772>baseMatrix </span><span style=color:#adb7c9>!== </span><span style=color:#9acc76>'undefined'</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>mvMatrix </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>mat4</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>clone</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>baseMatrix</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  } </span><span style=color:#cd74e8>else </span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>mat4</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>identity</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>mvMatrix</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>mat4</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>translate</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>mvMatrix</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>mvMatrix</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>position</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>mat4</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>rotate</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>mvMatrix</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>mvMatrix</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>                </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>rotate</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>], [</span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>mat4</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>rotate</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>mvMatrix</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>mvMatrix</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>                </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>rotate</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>], [</span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>mat4</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>rotate</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>mvMatrix</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>mvMatrix</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>                </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>rotate</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>2</span><span style=color:#abb2bf>], [</span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>mat4</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>scale</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>mvMatrix</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>mvMatrix</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>               </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>scale </span><span style=color:#adb7c9>|| </span><span style=color:#abb2bf>[</span><span style=color:#db9d63>0.6</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0.6</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0.6</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>  }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>mat3</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>normalFromMat4</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>nMatrix</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>mvMatrix</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>uniformMatrix4fv</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>program</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>uM</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>false</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>mvMatrix</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>uniformMatrix3fv</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>program</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>uN</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>false</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>nMatrix</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>bindBuffer</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ARRAY_BUFFER</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>vertexBuffer</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>vertexAttribPointer</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>program</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>aVertex</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>3</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>FLOAT</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>false</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>enableVertexAttribArray</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>program</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>aVertex</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>bindBuffer</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ARRAY_BUFFER</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>normalBuffer</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>vertexAttribPointer</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>program</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>aNormal</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>3</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>FLOAT</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>false</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>enableVertexAttribArray</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>program</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>aNormal</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>bindBuffer</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ELEMENT_ARRAY_BUFFER</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>indexBuffer</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>drawElements</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>rendering</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>                  </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>indices</span><span style=color:#abb2bf>.length,
</span><span style=color:#abb2bf>                  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>UNSIGNED_SHORT</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0
</span><span style=color:#abb2bf>                 );
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>bindBuffer</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ARRAY_BUFFER</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>null</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>bindBuffer</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ELEMENT_ARRAY_BUFFER</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>null</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>}
</span></code></pre><p>We will now prep the animation loop. What we want to do is to initialize the perspective and view matrix. <code>gl-matrix</code> comes to our help with the function <code>mat4.perspective</code> for the former, and we perform a simple translation from the identity matrix for the latter. We then set the GL context's clear color to black and enable the depth testing.<pre class=language-js data-lang=js style=color:#6c7079;background-color:#2b303b><code class=language-js data-lang=js><span style=color:#cd74e8>var </span><span style=color:#eb6772>uP </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>mat4</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>create</span><span style=color:#abb2bf>(), </span><span style=color:#eb6772>uV </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>mat4</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>create</span><span style=color:#abb2bf>();
</span><span style=color:#eb6772>mat4</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>perspective</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>uP</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>45</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>                 window.innerWidth </span><span style=color:#adb7c9>/ </span><span style=color:#abb2bf>window.innerHeight,
</span><span style=color:#abb2bf>                 </span><span style=color:#db9d63>0.01</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>500.0
</span><span style=color:#abb2bf>                );
</span><span style=color:#eb6772>mat4</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>identity</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>uV</span><span style=color:#abb2bf>);
</span><span style=color:#eb6772>mat4</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>translate</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>uV</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>uV</span><span style=color:#abb2bf>, [</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>, </span><span style=color:#adb7c9>-</span><span style=color:#db9d63>2</span><span style=color:#abb2bf>, </span><span style=color:#adb7c9>-</span><span style=color:#db9d63>10.0</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>
</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>clearColor</span><span style=color:#abb2bf>(</span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>);
</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>enable</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>DEPTH_TEST</span><span style=color:#abb2bf>);
</span></code></pre><p>We will have an array of meshes that will constitute our animation frames, so we create a simple <code>requestAnimationFrame</code>-based drawing loop that increments a counter by a time-dependent amount, so that we end up having the same animation speed no matter what the frame rate is. The counter is, clearly, a floating point value; we cast it to integer and reduce modulo the number of frames so an infinite animation loop is performed. Don't be afraid if some variables seem uninitialized; they are defined earlier in the code, in a part we will discuss soon.<pre class=language-js data-lang=js style=color:#6c7079;background-color:#2b303b><code class=language-js data-lang=js><span style=color:#cd74e8>var </span><span style=color:#eb6772>curMesh </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>curMeshf </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>(</span><span style=color:#cd74e8>function </span><span style=color:#5cb3fa>animate</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>time</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>delta </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>time </span><span style=color:#adb7c9>- </span><span style=color:#abb2bf>(</span><span style=color:#eb6772>animate</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>timeOld </span><span style=color:#adb7c9>|| </span><span style=color:#eb6772>time</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>clear</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>COLOR_BUFFER_BIT </span><span style=color:#adb7c9>| </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>DEPTH_BUFFER_BIT</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>uniformMatrix4fv</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>prog</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>uP</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>false</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>uP</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>uniformMatrix4fv</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>prog</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>uV</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>false</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>uV</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>if</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>.length </span><span style=color:#adb7c9>> </span><span style=color:#db9d63>0 </span><span style=color:#adb7c9>&& </span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>curMesh</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>!== </span><span style=color:#db9d63>undefined</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>    </span><span style=color:#5f697a;font-style:italic>// Rotate the mesh around the Y axis
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>].</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>rotate</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>+= </span><span style=color:#db9d63>0.02</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>curMesh</span><span style=color:#abb2bf>].</span><span style=color:#5cb3fa>draw</span><span style=color:#abb2bf>();
</span><span style=color:#abb2bf>  }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>if</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>.length </span><span style=color:#adb7c9>> </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>if</span><span style=color:#abb2bf>(</span><span style=color:#adb7c9>!</span><span style=color:#5ebfcc>isNaN</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>delta</span><span style=color:#abb2bf>)) </span><span style=color:#eb6772>curMeshf </span><span style=color:#adb7c9>+= </span><span style=color:#db9d63>0.05 </span><span style=color:#adb7c9>* </span><span style=color:#eb6772>delta</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>curMesh </span><span style=color:#adb7c9>= </span><span style=color:#5ebfcc>parseInt</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>curMeshf</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>curMesh </span><span style=color:#adb7c9>%= </span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>.length;
</span><span style=color:#abb2bf>  }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#5cb3fa>requestAnimationFrame</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>animate</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>animate</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>timeOld </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>time</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>}(</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>));
</span></code></pre><p>We now need some code to parse our <a href=http://en.wikipedia.org/wiki/Wavefront_.obj_file>Wavefront OBJ</a> files. I found <a href=http://jamwaffles.co.uk/tutorials/opengl/wavefrontloader/fileexplanation>this nice tutorial</a> that explains the ins and outs of the format using C++ syntax. If you made it this far, I am confident you can get the gist of it even if you don't know C++. Anyway here's the parsing code. We first read all the lines, parsing the vertices, normals and texture coordinates, then we parse the <em>faces</em> and adapt them to GL's standard - which is indices. We then build the <code>vertices</code>, <code>indices</code>, <code>normals</code> and <code>texc</code> (texture coordinates; present although not used here) arrays and return them as our <code>geometry</code> layout object.<pre class=language-js data-lang=js style=color:#6c7079;background-color:#2b303b><code class=language-js data-lang=js><span style=color:#cd74e8>function </span><span style=color:#5cb3fa>parseObj</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>t</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>vertices </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[], </span><span style=color:#eb6772>fverts </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[], </span><span style=color:#eb6772>indices </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[],
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>normals </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[], </span><span style=color:#eb6772>fnormals </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[], </span><span style=color:#eb6772>flist </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[],
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>texc </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[], </span><span style=color:#eb6772>ftexc </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[];
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>for</span><span style=color:#abb2bf>(</span><span style=color:#cd74e8>var </span><span style=color:#eb6772>i </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>i </span><span style=color:#adb7c9>< </span><span style=color:#eb6772>t</span><span style=color:#abb2bf>.length; </span><span style=color:#eb6772>i</span><span style=color:#adb7c9>++</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>line </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>t</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>i</span><span style=color:#abb2bf>], </span><span style=color:#eb6772>m </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>null</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>if</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>m </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>line</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>match</span><span style=color:#abb2bf>(</span><span style=color:#5ebfcc>/</span><span style=color:#cd74e8>^</span><span style=color:#5ebfcc>v (</span><span style=color:#db9d63>[</span><span style=color:#adb7c9>^</span><span style=color:#db9d63>\s]</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>)</span><span style=color:#db9d63>\s</span><span style=color:#5ebfcc>(</span><span style=color:#db9d63>[</span><span style=color:#adb7c9>^</span><span style=color:#db9d63>\s]</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>)</span><span style=color:#db9d63>\s</span><span style=color:#5ebfcc>(</span><span style=color:#db9d63>[</span><span style=color:#adb7c9>^</span><span style=color:#db9d63>\s]</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>)/</span><span style=color:#abb2bf>)) {
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>fverts</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#5ebfcc>parseFloat</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>]));
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>fverts</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#5ebfcc>parseFloat</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>2</span><span style=color:#abb2bf>]));
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>fverts</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#5ebfcc>parseFloat</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>3</span><span style=color:#abb2bf>]));
</span><span style=color:#abb2bf>    } </span><span style=color:#cd74e8>else if</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>m </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>line</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>match</span><span style=color:#abb2bf>(</span><span style=color:#5ebfcc>/</span><span style=color:#cd74e8>^</span><span style=color:#5ebfcc>vn (</span><span style=color:#db9d63>[</span><span style=color:#adb7c9>^</span><span style=color:#db9d63>\s]</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>)</span><span style=color:#db9d63>\s</span><span style=color:#5ebfcc>(</span><span style=color:#db9d63>[</span><span style=color:#adb7c9>^</span><span style=color:#db9d63>\s]</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>)</span><span style=color:#db9d63>\s</span><span style=color:#5ebfcc>(</span><span style=color:#db9d63>[</span><span style=color:#adb7c9>^</span><span style=color:#db9d63>\s]</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>)/</span><span style=color:#abb2bf>)) {
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>fnormals</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#5ebfcc>parseFloat</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>]));
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>fnormals</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#5ebfcc>parseFloat</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>2</span><span style=color:#abb2bf>]));
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>fnormals</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#5ebfcc>parseFloat</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>3</span><span style=color:#abb2bf>]));
</span><span style=color:#abb2bf>    } </span><span style=color:#cd74e8>else if</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>m </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>line</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>match</span><span style=color:#abb2bf>(</span><span style=color:#5ebfcc>/</span><span style=color:#cd74e8>^</span><span style=color:#5ebfcc>vt (</span><span style=color:#db9d63>[</span><span style=color:#adb7c9>^</span><span style=color:#db9d63>\s]</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>)</span><span style=color:#db9d63>\s</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>(</span><span style=color:#db9d63>[</span><span style=color:#adb7c9>^</span><span style=color:#db9d63>\s]</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>)/</span><span style=color:#abb2bf>)) {
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>ftexc</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#5ebfcc>parseFloat</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>]));
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>ftexc</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#5ebfcc>parseFloat</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>2</span><span style=color:#abb2bf>]));
</span><span style=color:#abb2bf>    } </span><span style=color:#cd74e8>else if</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>m </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>line</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>match</span><span style=color:#abb2bf>(</span><span style=color:#5ebfcc>/</span><span style=color:#cd74e8>^</span><span style=color:#5ebfcc>f (</span><span style=color:#db9d63>\d</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>)\/(</span><span style=color:#db9d63>\d</span><span style=color:#adb7c9>*</span><span style=color:#5ebfcc>)\/(</span><span style=color:#db9d63>\d</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>)</span><span style=color:#db9d63>\s</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>(</span><span style=color:#db9d63>\d</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>)\/(</span><span style=color:#db9d63>\d</span><span style=color:#adb7c9>*</span><span style=color:#5ebfcc>)\/(</span><span style=color:#db9d63>\d</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>)</span><span style=color:#db9d63>\s</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>(</span><span style=color:#db9d63>\d</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>)\/(</span><span style=color:#db9d63>\d</span><span style=color:#adb7c9>*</span><span style=color:#5ebfcc>)\/(</span><span style=color:#db9d63>\d</span><span style=color:#adb7c9>+</span><span style=color:#5ebfcc>)/</span><span style=color:#abb2bf>)) {
</span><span style=color:#abb2bf>      </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>i1 </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>], </span><span style=color:#eb6772>i2 </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>4</span><span style=color:#abb2bf>], </span><span style=color:#eb6772>i3 </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>7</span><span style=color:#abb2bf>],
</span><span style=color:#abb2bf>          </span><span style=color:#eb6772>n1 </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>3</span><span style=color:#abb2bf>], </span><span style=color:#eb6772>n2 </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>6</span><span style=color:#abb2bf>], </span><span style=color:#eb6772>n3 </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>9</span><span style=color:#abb2bf>],
</span><span style=color:#abb2bf>          </span><span style=color:#eb6772>f1 </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>2</span><span style=color:#abb2bf>], </span><span style=color:#eb6772>f2 </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>5</span><span style=color:#abb2bf>], </span><span style=color:#eb6772>f3 </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>m</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>8</span><span style=color:#abb2bf>];
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>i1</span><span style=color:#adb7c9>--</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>i2</span><span style=color:#adb7c9>--</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>i3</span><span style=color:#adb7c9>--</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>n1</span><span style=color:#adb7c9>--</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>n2</span><span style=color:#adb7c9>--</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>n3</span><span style=color:#adb7c9>--</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>f1</span><span style=color:#adb7c9>--</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>f2</span><span style=color:#adb7c9>--</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>f3</span><span style=color:#adb7c9>--</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>flist</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>([</span><span style=color:#eb6772>i1</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>n1</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>f1</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>flist</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>([</span><span style=color:#eb6772>i2</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>n2</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>f2</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>flist</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>([</span><span style=color:#eb6772>i3</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>n3</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>f3</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>for</span><span style=color:#abb2bf>(</span><span style=color:#cd74e8>var </span><span style=color:#eb6772>i </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>i </span><span style=color:#adb7c9>< </span><span style=color:#eb6772>flist</span><span style=color:#abb2bf>.length; </span><span style=color:#eb6772>i</span><span style=color:#adb7c9>++</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>f </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>flist</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>i</span><span style=color:#abb2bf>];
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>indices</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>i</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>vertices</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>fverts</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>f</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>vertices</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>fverts</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>f</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3 </span><span style=color:#adb7c9>+ </span><span style=color:#db9d63>1</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>vertices</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>fverts</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>f</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3 </span><span style=color:#adb7c9>+ </span><span style=color:#db9d63>2</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>normals</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>fnormals</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>f</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>normals</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>fnormals</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>f</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3 </span><span style=color:#adb7c9>+ </span><span style=color:#db9d63>1</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>normals</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>fnormals</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>f</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3 </span><span style=color:#adb7c9>+ </span><span style=color:#db9d63>2</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>texc</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>ftexc</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>f</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>2</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>2</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>texc</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>ftexc</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>f</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>2</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>2 </span><span style=color:#adb7c9>+ </span><span style=color:#db9d63>1</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>  }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>return </span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>    vertices: </span><span style=color:#eb6772>vertices</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>    normals: </span><span style=color:#eb6772>normals</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>    indices: </span><span style=color:#eb6772>indices</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>    textureCoordinates: </span><span style=color:#eb6772>texc </span><span style=color:#5f697a;font-style:italic>// unused here
</span><span style=color:#abb2bf>  };
</span><span style=color:#abb2bf>}
</span></code></pre><h3 id=2-2-keyframe-animation-at-last>2.2 Keyframe animation, at last!</h3><p>Boilerplate code is finally over! Let's see how we can load, parse and animate our model.<p>We have a couple of options here. If you recall, we keyframed our rigged model at keyframes 0, 10, 20, 30 and 40, and Blender exported 40 <code>.obj</code> files for us. In this case we might be fine, but if the geometry was just a tiny little bit more complicated than that we'd be in for some pain. I designed a model for a project of mine which is a bit more complex but still very low poly, and with just a couple more keyframes than this I found myself with 10 megabytes worth of files for a legs-only animation. Unacceptable, considering the simplicity.<p>If we don't mind employing a little GPU buffer space (and we don't mind, do we?), we may resort to a different solution that is a nice middle ground between loading times and algorithmic load. We will just make use of a bunch of the exported frames, namely the <em>keyframes</em> - which, by themselves, could not make for a nice and smooth animation - and calculate the frames in between (<em>tween</em>) via linear interpolation.<p>Linear interpolation (<code>lerp</code> for the buddies) is a formula that calculates an intermediate point between two numbers, or vector, or matrices. This point is calculated as if it were on a line (hence the <em>linear</em> part). We can find as many or as few intermediate points as we need, but we must supply a parameter that will tell us how far or how close we are to one of the two points. This parameter ranges from 0.0 to 1.0 where 0.0 means "exactly the first point", 1.0 means "exactly the second point", 0.5 means "exactly in the middle of the two", you get the idea. So for example if we need ten intermediate frames, we shall make ten linear interpolations at ten equally spaced points between two frames. This means pushing a frame on the stack, sampling between the first and second keyframe at 0.1, then at 0.2, ... then at 0.9, then taking the final point and pushing it onto the stack with the other frames - or sampling another at 1.0, which is the same thing. Then we repeat the process by interpolating between the former "second keyframe" and the next keyframe at the same points 0.1 - 1.0 as before; notice that we skip sampling at 0.0 except for the first time, since we already have on stack the frame corresponding to the new frame interpolated at 0.0. Also, the last keyframe we stop interpolating at 0.9 since the sample at 1.0 would be the same as the absolute first frame we pushed.<p>So this is how we do it: we pick four keyframes (the first and the last will be one and the same, so we leave out the fifth), we load them synchronously via <code>XMLHttpRequest</code>, we parse them, we interpolate 10 frames, get 10 geometries, create a <code>Mesh</code> for each of those and push it onto the <code>meshes</code> array. The XHRs are synchronous for the same reason I explained earlier, plus for the fact that we need each frame to arrive at the exact same moment we need it, or we risk getting the order wrong.<pre class=language-js data-lang=js style=color:#6c7079;background-color:#2b303b><code class=language-js data-lang=js><span style=color:#5f697a;font-style:italic>// objFile holds the four keyframes we're going to use
</span><span style=color:#cd74e8>var </span><span style=color:#eb6772>meshes </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[], </span><span style=color:#eb6772>objFiles </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[
</span><span style=color:#abb2bf>  </span><span style=color:#9acc76>"skeletal_000000.obj"</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>  </span><span style=color:#9acc76>"skeletal_000010.obj"</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>  </span><span style=color:#9acc76>"skeletal_000020.obj"</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>  </span><span style=color:#9acc76>"skeletal_000030.obj"
</span><span style=color:#abb2bf>];
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>for</span><span style=color:#abb2bf>(</span><span style=color:#cd74e8>var </span><span style=color:#eb6772>i </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>i </span><span style=color:#adb7c9>< </span><span style=color:#eb6772>objFiles</span><span style=color:#abb2bf>.length; </span><span style=color:#eb6772>i</span><span style=color:#adb7c9>++</span><span style=color:#abb2bf>) (</span><span style=color:#cd74e8>function</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>obj</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>i</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#5f697a;font-style:italic>// XHRs are sync here because we must push the meshes in the correct
</span><span style=color:#abb2bf>  </span><span style=color:#5f697a;font-style:italic>// order. It's okay here because we don't need anything fancy but
</span><span style=color:#abb2bf>  </span><span style=color:#5f697a;font-style:italic>// you should never do this in the real world and opt for a correct
</span><span style=color:#abb2bf>  </span><span style=color:#5f697a;font-style:italic>// asynchronous behaviour, but this is not the place to discuss it.
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>xhr </span><span style=color:#adb7c9>= new </span><span style=color:#abb2bf>XMLHttpRequest();
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>xhr</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>open</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>'GET'</span><span style=color:#abb2bf>, </span><span style=color:#9acc76>'frames/' </span><span style=color:#adb7c9>+ </span><span style=color:#eb6772>obj</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>false</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>xhr</span><span style=color:#abb2bf>.onreadystatechange </span><span style=color:#adb7c9>= </span><span style=color:#cd74e8>function</span><span style=color:#abb2bf>() {
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>if</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.readyState </span><span style=color:#adb7c9>!== </span><span style=color:#db9d63>4</span><span style=color:#abb2bf>) </span><span style=color:#cd74e8>return</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>t </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>this</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>response</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>split</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>'</span><span style=color:#5ebfcc>\n</span><span style=color:#9acc76>'</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>geom </span><span style=color:#adb7c9>= </span><span style=color:#5cb3fa>parseObj</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>t</span><span style=color:#abb2bf>); </span><span style=color:#5f697a;font-style:italic>// parse file
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>geom</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>rendering </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>gl</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>TRIANGLES</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>if</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>.length </span><span style=color:#adb7c9>> </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>      </span><span style=color:#5f697a;font-style:italic>// If this is not the first object, then the pos/rot/scale should
</span><span style=color:#abb2bf>      </span><span style=color:#5f697a;font-style:italic>// all reference the pos/rot/scale on the very first mesh, so
</span><span style=color:#abb2bf>      </span><span style=color:#5f697a;font-style:italic>// we can alter these and the changes will propagate through the
</span><span style=color:#abb2bf>      </span><span style=color:#5f697a;font-style:italic>// meshes. There are way better ways to do this, but still
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>geom</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>position </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>].</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>position</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>geom</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>rotate </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>].</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>rotate</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>geom</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>scale </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>].</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>scale</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>      </span><span style=color:#5f697a;font-style:italic>// Pick the last geometry from the previous iteration
</span><span style=color:#abb2bf>      </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>prevGeom </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>.length </span><span style=color:#adb7c9>- </span><span style=color:#db9d63>1</span><span style=color:#abb2bf>].</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>      </span><span style=color:#5f697a;font-style:italic>// Get ten geometries linearly interpolated (lerped) between
</span><span style=color:#abb2bf>      </span><span style=color:#5f697a;font-style:italic>// the current and the previous keyframes
</span><span style=color:#abb2bf>      </span><span style=color:#cd74e8>for</span><span style=color:#abb2bf>(</span><span style=color:#cd74e8>var </span><span style=color:#eb6772>k </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>1</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>k </span><span style=color:#adb7c9>< </span><span style=color:#db9d63>10</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>k</span><span style=color:#adb7c9>++</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>lg </span><span style=color:#adb7c9>= </span><span style=color:#5cb3fa>lerpGeometry</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>prevGeom</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>geom</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>k</span><span style=color:#adb7c9>/</span><span style=color:#db9d63>10</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>        </span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#adb7c9>new </span><span style=color:#abb2bf>Mesh(</span><span style=color:#eb6772>lg</span><span style=color:#abb2bf>));
</span><span style=color:#abb2bf>      }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    } </span><span style=color:#cd74e8>else </span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>geom</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>position </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[</span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>];
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>geom</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>rotate </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[</span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>0.0</span><span style=color:#abb2bf>];
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>geom</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>scale </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[</span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>1.0</span><span style=color:#abb2bf>];
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#adb7c9>new </span><span style=color:#abb2bf>Mesh(</span><span style=color:#eb6772>geom</span><span style=color:#abb2bf>));
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#5f697a;font-style:italic>// Finally, lerp last and first keyframe to get a
</span><span style=color:#abb2bf>    </span><span style=color:#5f697a;font-style:italic>// seamless animation
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>if</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>i </span><span style=color:#adb7c9>== </span><span style=color:#eb6772>objFiles</span><span style=color:#abb2bf>.length </span><span style=color:#adb7c9>- </span><span style=color:#db9d63>1</span><span style=color:#abb2bf>) </span><span style=color:#cd74e8>for</span><span style=color:#abb2bf>(</span><span style=color:#cd74e8>var </span><span style=color:#eb6772>k </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>k </span><span style=color:#adb7c9>< </span><span style=color:#db9d63>10</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>k</span><span style=color:#adb7c9>++</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>      </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>lg </span><span style=color:#adb7c9>= </span><span style=color:#5cb3fa>lerpGeometry</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>geom</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>[</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>].</span><span style=color:#eb6772>geometry</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>k</span><span style=color:#adb7c9>/</span><span style=color:#db9d63>10</span><span style=color:#abb2bf>);
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>meshes</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#adb7c9>new </span><span style=color:#abb2bf>Mesh(</span><span style=color:#eb6772>lg</span><span style=color:#abb2bf>));
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>  }
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>xhr</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>send</span><span style=color:#abb2bf>();
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>}(</span><span style=color:#eb6772>objFiles</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>i</span><span style=color:#abb2bf>], </span><span style=color:#eb6772>i</span><span style=color:#abb2bf>));
</span></code></pre><p>The <code>LERP</code>ing operation itself is quite simple. We initialize a new object with the properties of the first keyframe, replace the vertices, indices and normals with fresh, new empty arrays, and fill them up with the interpolated values. Actually, filling up the indices array wouldn't be necessary since we know the order is the same in each keyframe, we could cut it out for added performance and space saved; creating new vertices and normals array is important, though.<pre class=language-js data-lang=js style=color:#6c7079;background-color:#2b303b><code class=language-js data-lang=js><span style=color:#cd74e8>function </span><span style=color:#5cb3fa>lerpGeometry</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>a</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>b</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>t</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>out </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>{}, </span><span style=color:#eb6772>i</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#5f697a;font-style:italic>// Copy non strictly geometry-related properties in the output.
</span><span style=color:#abb2bf>  </span><span style=color:#5f697a;font-style:italic>// This is specific to the format used in this code and may or
</span><span style=color:#abb2bf>  </span><span style=color:#5f697a;font-style:italic>// may not be useful in other contexts.
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>for</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>i </span><span style=color:#adb7c9>in </span><span style=color:#eb6772>a</span><span style=color:#abb2bf>) </span><span style=color:#cd74e8>if</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>a</span><span style=color:#abb2bf>.</span><span style=color:#5cb3fa>hasOwnProperty</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>i</span><span style=color:#abb2bf>)) </span><span style=color:#eb6772>out</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>i</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>a</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>i</span><span style=color:#abb2bf>];
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#5f697a;font-style:italic>// Assign new, empty arrays to our geometric properties
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>out</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>vertices </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[];
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>out</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>indices </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[];
</span><span style=color:#abb2bf>  </span><span style=color:#eb6772>out</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>normals </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[];
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#5f697a;font-style:italic>// Loop through the indices "just like" the GL pipeline would
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>for</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>i </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>i </span><span style=color:#adb7c9>< </span><span style=color:#eb6772>a</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>indices</span><span style=color:#abb2bf>.length; </span><span style=color:#eb6772>i</span><span style=color:#adb7c9>++</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>    </span><span style=color:#5f697a;font-style:italic>// Current index. Same index should match the same vertices on
</span><span style=color:#abb2bf>    </span><span style=color:#5f697a;font-style:italic>// both a and b geometries
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>var </span><span style=color:#eb6772>index </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>a</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>indices</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>i</span><span style=color:#abb2bf>];
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#5f697a;font-style:italic>// Push the index as-is
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>out</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>indices</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>a</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>indices</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>i</span><span style=color:#abb2bf>]);
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#5f697a;font-style:italic>// Lerp the vertices. Take (1-t) % from a, (t) % from b.
</span><span style=color:#abb2bf>    </span><span style=color:#5f697a;font-style:italic>// Note that t should always be between 0 and 1
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>out</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>vertices</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(
</span><span style=color:#abb2bf>      </span><span style=color:#5f697a;font-style:italic>// X component
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>a</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>vertices</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>index </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#abb2bf>(</span><span style=color:#db9d63>1 </span><span style=color:#adb7c9>- </span><span style=color:#eb6772>t</span><span style=color:#abb2bf>) </span><span style=color:#adb7c9>+
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>b</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>vertices</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>index </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#eb6772>t</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>      </span><span style=color:#5f697a;font-style:italic>// Y component
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>a</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>vertices</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>index </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3 </span><span style=color:#adb7c9>+ </span><span style=color:#db9d63>1</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#abb2bf>(</span><span style=color:#db9d63>1 </span><span style=color:#adb7c9>- </span><span style=color:#eb6772>t</span><span style=color:#abb2bf>) </span><span style=color:#adb7c9>+
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>b</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>vertices</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>index </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3 </span><span style=color:#adb7c9>+ </span><span style=color:#db9d63>1</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#eb6772>t</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>      </span><span style=color:#5f697a;font-style:italic>// Z component
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>a</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>vertices</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>index </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3 </span><span style=color:#adb7c9>+ </span><span style=color:#db9d63>2</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#abb2bf>(</span><span style=color:#db9d63>1 </span><span style=color:#adb7c9>- </span><span style=color:#eb6772>t</span><span style=color:#abb2bf>) </span><span style=color:#adb7c9>+
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>b</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>vertices</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>index </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3 </span><span style=color:#adb7c9>+ </span><span style=color:#db9d63>2</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#eb6772>t
</span><span style=color:#abb2bf>    );
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#5f697a;font-style:italic>// Lerp the normal. Same as the vertex
</span><span style=color:#abb2bf>    </span><span style=color:#eb6772>out</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>normals</span><span style=color:#abb2bf>.</span><span style=color:#5ebfcc>push</span><span style=color:#abb2bf>(
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>a</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>normals</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>index </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#abb2bf>(</span><span style=color:#db9d63>1 </span><span style=color:#adb7c9>- </span><span style=color:#eb6772>t</span><span style=color:#abb2bf>) </span><span style=color:#adb7c9>+
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>b</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>normals</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>index </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#eb6772>t</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>a</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>normals</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>index </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3 </span><span style=color:#adb7c9>+ </span><span style=color:#db9d63>1</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#abb2bf>(</span><span style=color:#db9d63>1 </span><span style=color:#adb7c9>- </span><span style=color:#eb6772>t</span><span style=color:#abb2bf>) </span><span style=color:#adb7c9>+
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>b</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>normals</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>index </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3 </span><span style=color:#adb7c9>+ </span><span style=color:#db9d63>1</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#eb6772>t</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>a</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>normals</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>index </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3 </span><span style=color:#adb7c9>+ </span><span style=color:#db9d63>2</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#abb2bf>(</span><span style=color:#db9d63>1 </span><span style=color:#adb7c9>- </span><span style=color:#eb6772>t</span><span style=color:#abb2bf>) </span><span style=color:#adb7c9>+
</span><span style=color:#abb2bf>      </span><span style=color:#eb6772>b</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>normals</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>index </span><span style=color:#adb7c9>* </span><span style=color:#db9d63>3 </span><span style=color:#adb7c9>+ </span><span style=color:#db9d63>2</span><span style=color:#abb2bf>] </span><span style=color:#adb7c9>* </span><span style=color:#eb6772>t
</span><span style=color:#abb2bf>    );
</span><span style=color:#abb2bf>  }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>  </span><span style=color:#cd74e8>return </span><span style=color:#eb6772>out</span><span style=color:#abb2bf>;
</span><span style=color:#abb2bf>}
</span></code></pre><p><img alt="Final result" src=/data/2014-04-22-implementing-keyframe-animation/result.png><p>So here's our final result. If you have any questions, please feel free to ask in the comments and I will gladly integrate anything missing or useful. Again, to get the code of the tutorial along with the pre-exported OBJs and Blender file, click <a href=/data/2014-04-22-implementing-keyframe-animation/veeenu-implementing-keyframe-animation.tgz>here</a>, or click <a href=https://github.com/veeenu/veeenu.github.io/tree/master/data/2014-04-22-implementing-keyframe-animation/veeenu-implementing-keyframe-animation>here</a> to view them directly on GitHub. Hope you enjoyed!</section></article><ul class=links><li><a href=https://github.com/veeenu target=_blank> <img alt=GitHub src=/img/github.svg> </a><li><a href=https://www.linkedin.com/in/andreavenuta/ target=_blank> <img alt=LinkedIn src=/img/linkedin.svg> </a><li><a href=https://twitter.com/johndisandonato target=_blank> <img alt=Twitter src=/img/twitter.svg> </a><li><a href=https://twitch.tv/johndisandonato target=_blank> <img alt=Twitch.tv src=/img/twitch.svg> </a><li><a href=cv.pdf target=_blank> <img alt="CV - Icon made by Vitaly Gorbachev (https://www.flaticon.com/authors/vitaly-gorbachev) from www.flaticon.com" src=/img/cv.svg> </a></ul></div><script async src=/katex.min.js></script><script data-cf-beacon='{"token": "9c82a3cc7db742e4bb18aebd57b40893"}' defer src=https://static.cloudflareinsights.com/beacon.min.js></script>